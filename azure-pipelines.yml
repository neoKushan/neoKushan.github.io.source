trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

steps:
- checkout: self
  submodules: false  # We use Hugo modules now, not git submodules
  fetchDepth: 0

# Install Go (required for Hugo modules)
- task: GoTool@0
  inputs:
    version: '1.23'
  displayName: 'Install Go'

# Install Node.js (required for TailwindCSS and Pagefind)
- task: NodeTool@0
  inputs:
    versionSpec: '22.x'
  displayName: 'Install Node.js 22'

# Install pnpm
- script: |
    npm install -g pnpm@10.14.0
  displayName: 'Install pnpm'

# Install dependencies
- script: |
    pnpm install --no-frozen-lockfile
    echo "=== Verifying TailwindCSS installation ==="
    ls -la node_modules/.bin/tailwindcss
    chmod +x node_modules/.bin/tailwindcss
    ./node_modules/.bin/tailwindcss --version
  displayName: 'Install dependencies with pnpm'

# Install Hugo Extended
- script: |
    wget https://github.com/gohugoio/hugo/releases/download/v0.154.5/hugo_extended_0.154.5_linux-amd64.tar.gz
    tar -xzf hugo_extended_0.154.5_linux-amd64.tar.gz
    sudo mv hugo /usr/local/bin/
    hugo version
  displayName: 'Install Hugo Extended 0.154.5'

# Initialize Hugo modules
- script: |
    hugo mod get -u
    hugo mod tidy
  displayName: 'Download and update Hugo modules'

# Build site (Hugo + Pagefind)
- script: |
    echo "=== Adding node_modules/.bin to PATH ==="
    export PATH="$(pwd)/node_modules/.bin:$PATH"
    echo "PATH contains node_modules/.bin"
    echo "=== Verifying tooling ==="
    which tailwindcss || echo "tailwindcss not in PATH"
    tailwindcss --version || echo "Cannot execute tailwindcss"
    echo "=== Building Hugo site ==="
    hugo --minify --gc --logLevel info
    echo "=== Checking CSS output ==="
    ls -lh public/css/ || echo "No CSS directory found"
    if [ -d public/css ]; then
      echo "CSS files size:"
      find public/css -name "*.css" -exec ls -lh {} \;
    fi
    echo "=== Running Pagefind ==="
    pnpm run pagefind
    echo "=== Build complete ==="
  displayName: 'Build site with Hugo and Pagefind'
  env:
    HUGO_ENVIRONMENT: production
    HUGO_ENABLEGITINFO: 'true'

# Verify build output
- script: |
    echo "=== Verifying build artifacts ==="
    ls -lh public/
    echo "=== Checking .nojekyll file ==="
    if [ -f public/.nojekyll ]; then
      echo "✓ .nojekyll exists - GitHub Pages will serve underscore files"
      ls -la public/.nojekyll
    else
      echo "✗ WARNING: .nojekyll missing - GitHub Pages will ignore underscore files!"
      exit 1
    fi
    echo "=== CSS files ==="
    find public/css -name "*.css" 2>/dev/null | head -10 || echo "No CSS files found"
    echo "=== JS files ==="
    find public/js -name "*.js" 2>/dev/null | head -10 || echo "No JS files found"
    echo "=== Files with underscores (must be included) ==="
    find public -name "_*" -type f | head -10
    echo "=== Hugo Blox dist files ==="
    ls -la public/dist/ 2>/dev/null || echo "No dist directory"
    echo "=== Total size ==="
    du -sh public/
  displayName: 'Verify build output'

# Publish build artifacts
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.SourcesDirectory)/public'
    ArtifactName: 'drop'
    publishLocation: 'Container'
  displayName: 'Publish Artifact: drop'
